image: maven:3.8.4-jdk-11  # Docker image to use for the build environment

pipelines:
  default:
    - step:
        name: Create Update Script
        script:
          # Create the update-pom.sh script
          - echo '#!/bin/bash' > update-pom.sh
          - echo 'CONFIGURATION="<configuration>\n    <cloudHubDeployment>\n        <uri>https://anypoint.mulesoft.com/</uri>\n        <muleVersion>4.7.0</muleVersion>\n        <username>Feriel</username>\n        <password>Feriel123**</password>\n        <applicationName>projectcicd</applicationName>\n        <businessGroup>ITMMA</businessGroup>\n        <environment>Develop</environment>\n        <workers>1</workers>\n        <objectStoreV2>true</objectStoreV2>\n    </cloudHubDeployment>\n</configuration>"' >> update-pom.sh
          - echo 'POM_FILE="pom.xml"' >> update-pom.sh
          - echo 'sed -i "/<\/plugin>/i $CONFIGURATION" $POM_FILE' >> update-pom.sh
          - chmod +x update-pom.sh  # Make the script executable

    - step:
        name: Update pom.xml
        script:
          - ./update-pom.sh  # Run the script to modify pom.xml

    - step:
        name: Build
        caches:
          - maven
        script:
          - mvn clean package  # Run Maven to clean and package the code

    - step:
        name: Deploy to CloudHub
        script:
          - mvn -X deploy -DmuleDeploy -DskipTests  # Deploy the code to CloudHub

    - step:
        name: Failure Message
        trigger: manual  # Triggered manually if previous steps fail
        script:
          - echo 'Build or deployment failed.'  # Log a message if the build or deployment fails

